# 소켓 통신 예제
소켓 통신을 위해서는 서버와 클라이언트가 필요합니다. 클라이언트가 서버에게 데이터를 송신하면 서버가 데이터를 수신 및 처리해서 클라이언트에게 데이터를 송신합니다. 이러한 네트워크 통신을 위해 소켓을 이용합니다. 톡희에서는 LuaSocket이라는 사용하기 쉽고 편리한 소켓 통신 라이브러리를 기본적으로 제공하고 있습니다. 이 예제에서는 이 라이브러리를 이용해 간단한 소켓 통신 프로그램을 만듭니다.

## 서버 개발
우선 서버를 먼저 개발하겠습니다. 우리가 만들 서버는 클라이언트로부터 숫자를 수신해 그 숫자에 1을 더해 다시 클라이언트에 송신하는 서버입니다. 우선 Lua 스크립트부터 작성하겠습니다.
```lua
function send()
    return 0
end

function receive(value)
    local socket = require("socket")
    local server = socket.tcp()
    server:bind("127.0.0.1", 12345) # 1
    server:listen(1) # 2

    while true do
        local client = server:accept()
        local received = client:receive()
        local data = tostring(tonumber(received) + 1) .. "\n"
        client:send(data)
        client:close()
    end
end

function send_count()
    return 0
end
```
아희 코드에서 확장으로 아무 값이나 전달하면 receive 함수가 호출되어 서버가 실행됩니다. 현재 컴퓨터의 12345번 포트에 TCP 서버를 열도록 되어 있는데, 큰 대학교에는 하나의 주소가 있고, 그 안의 건물마다 건물 번호가 지정되어 있듯이 IP 주소는 컴퓨터 자체의 주소를 나타내고 포트는 그 안에 있는 소켓의 번호를 나타냅니다. 포트는 0~65535까지 총 65536개 중 하나를 선택할 수 있는데, 코드에서 *1번*을 수정하면 12345번 포트가 아닌 다른 포트에 소켓을 열 수 있습니다. TCP는 서버와 클라이언트가 네트워크 통신할 때 어떤 방식으로 통신할지를 정의한 통신 규약입니다. 코드에서 *2번*에서는 서버에 최대로 접속할 수 있는 클라이언트 수를 제한하는데, 여기에서는 최대 동시 접속 가능한 클라이언트의 수가 1입니다.

서버가 실행되면 클라이언트의 접속을 대기하는데, 클라이언트가 서버에 접속하면 클라이언트로부터 데이터를 수신 받습니다. 이 데이터는 문자열의 형태로 수신되기 때문에 숫자로 변환한 뒤 변환한 값에 1을 더하고, 이를 다시 문자열로 변환한 뒤 끝에 개행 문자를 덧붙여 클라이언트에게 송신합니다. 그 후 그 클라이언트와의 연결을 종료하고 다른 클라이언트의 접속을 대기하는데, 이러한 과정이 무한히 반복됩니다.

**주의!** LuaSocket은 데이터를 수신할 때 개행 문자(`\n`)까지 수신하도록 되어있기 때문에 송신할 데이터의 끝에는 반드시 개행 문자를 덧붙여야 합니다.

이제 아희 코드를 작성하겠습니다.
```
샇바희
```
위에서 작성한 Lua 스크립트에 의하면 아희 코드에서 확장으로 아무 값이나 전달하면 서버가 실행되도록 되어 있습니다. 때문에 확장으로 0을 전달하여(다른 값을 전달해도 무관합니다.) 서버를 실행하도록 아희 코드를 작성했습니다.

이제 Extension.json 파일을 작성하겠습니다.
```json
{
    "Name": "Server",
    "Target": "Aheui",
    "Type": "Lua",
    "Source": "Server.lua"
}
```
Source 프로퍼티의 값은 여러분들이 작성한 Lua 스크립트의 파일명으로 하면 됩니다.

이제 Extension.json 파일과 Lua 스크립트 파일을 하나의 파일로 압축하면 서버의 준비가 완료됩니다.

## 클라이언트 개발
이제 클라이언트를 만들어 보겠습니다. 마찬가지로 Lua 스크립트부터 작성하겠습니다.
```lua
function send()
    local result = received
    received = nil
    return result
end

function receive(value)
    local socket = require("socket")
    local client = socket.tcp()
    client:connect("127.0.0.1", 12345) # 1
    client:send(tostring(value) .. "\n")
    local temp = client:receive()
    local temp_len = string.len(temp)
    received = tonumber(string.sub(temp, 1, temp_len))
    client:close()
end

function send_count()
    return received == nil and 0 or 1
end
```
앞에서 개발한 서버와 마찬가지로 아희 코드에서 확장으로 값이 전달되면 클라이언트가 실행됩니다. 우리가 앞에서 개발한 서버와 연결돼야 하기 때문에 코드에서 *1번*의 포트는 반드시 앞에서 정한 서버의 포트와 같아야 합니다. 또, 만약 서버가 클라이언트와 같은 컴퓨터가 아닌 다른 컴퓨터에서 실행됐다면 코드에서 *1번*의 IP 주소가 서버가 실행될 컴퓨터의 IP 주소로 수정돼야 합니다. 이 예제에서는 한 컴퓨터 내에서 서버와 클라이언트를 둘 다 실행합니다.

클라이언트가 실행되면 서버와 연결을 시도하는데, 성공하면 아희 코드로부터 전달 받은 값을 서버로 송신하고, 다시 서버로부터 데이터를 수신 받습니다. 수신된 데이터는 숫자로 변환돼 received 전역 변수에 저장되며, 데이터가 변수에 저장된 후에는 서버와의 연결을 종료합니다.

이렇게 변수에 저장된 데이터는 나중에 아희 코드에서 데이터 전달을 요청했을 때 아희 코드에게 전달됩니다. 만약 데이터가 저장되지 않은 상태에서 아희 코드에서 데이터 전달을 요청했을 경우 데이터는 전달되지 않으며, 아희 코드에서 실행 흐름이 반대로 바뀌게 됩니다(스택이나 큐에 데이터가 없을 때 Pop을 한 것처럼요.).

이제 아희 코드를 작성해 보겠습니다.
```
샇방망희
```
위에서 작성한 Lua 스크립트에 의하면 아희 코드에서 확장으로 값이 전달되면 클라이언트가 실행되고 그 값이 서버로 송신됩니다. 따라서 사용자에게 숫자 입력을 요청한 뒤 사용자가 입력한 값을 확장으로 전달합니다. 서버와 클라이언트의 통신이 성공적으로 이루어지면 사용자가 입력한 값보다 1 큰 값이 화면이 출력된 후 프로그램이 종료됩니다.

이제 Extension.json 파일을 작성하겠습니다.
```json
{
    "Name": "client",
    "Target": "Aheui",
    "Type": "Lua",
    "Source": "Client.lua"
}
```
작성 방법은 서버의 Extension.json 파일 작성법과 같습니다. 서버와 마찬가지로 Extension.json 파일과 Lua 스크립트 파일을 하나의 파일로 압축하면 클라이언트의 준비가 완료됩니다.

## 테스트
서버와 클라이언트의 아희 코드를 각각 Server.aheui, Client.aheui 파일에 저장했다고 하겠습니다. 서버가 클라이언트의 연결을 대기하는 구조이기 때문에 클라이언트보다 서버를 먼저 실행해야 합니다.
```
$ ./talkheui Server.aheui Server.zip
```
Server.zip은 서버의 Extension.json 파일과 Lua 스크립트 파일을 압축한 파일입니다. 위 명령어를 입력하면 톡희가 종료되지 않고 계속 실행된 상태를 유지하는 것을 확인하실 수 있습니다. 이는 서버가 실행돼 클라이언트의 접속을 대기하는 상태입니다.
```
$ ./talkheui Client.aheui Client.zip
```
다른 Shell을 실행해 위 명령어를 입력하면 사용자의 숫자 입력을 대기하는 상태가 됩니다. 이 때 아무 숫자나 입력하면 그 숫자에 1이 더해진 숫자가 출력되는 것을 확인하실 수 있습니다. 이를 통해 찰나의 순간에 서버와 클라이언트의 통신이 성공적으로 이루어졌음을 알 수 있습니다.

이 예제에서 간단한 소켓 통신 프로그램을 만들어 보았습니다. 이 예제에서 다룬 내용들을 잘 응용한다면 여러분들은 분명히 더 멋진 아희 확장을 만드실 수 있을 것입니다!